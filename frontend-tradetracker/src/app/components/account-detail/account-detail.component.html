<div class="account-detail-container" *ngIf="(account$ | async) as account">
  <div class="header">
    <div class="title-section">
      <h2>{{ account.name }}</h2>
      <span class="badge" [ngClass]="{'badge-usd': account.currency === 'USD', 'badge-eur': account.currency === 'EUR'}">
        {{ account.currency }}
      </span>
    </div>
    <button class="btn btn-secondary" routerLink="/accounts"><i class="fas fa-arrow-left mr-2"></i>Retour aux comptes</button>
  </div>
  
  <div class="account-overview">
    <div class="card">
      <div class="card-header">Informations Générales</div>
      <div class="card-body">
        <div class="info-row">
          <span class="label">Broker:</span>
          <span class="value">{{ account.broker }}</span>
        </div>
        <div class="info-row">
          <span class="label">Solde actuel:</span>
          <span class="value">{{ account.currentBalance | currency:account.currency }}</span>
        </div>
        <div class="info-row target-balance-row">
          <span class="label">Objectif:</span>
          <div class="editable-value">
            <span class="value" *ngIf="!showTargetForm">{{ account.targetBalance | currency:account.currency }}</span>
            <button class="edit-btn" *ngIf="!showTargetForm" (click)="showTargetForm = true">
              <i class="fas fa-edit edit-icon"></i>
            </button>
            <form [formGroup]="targetForm" (ngSubmit)="updateTargetBalance(); showTargetForm = false" *ngIf="showTargetForm" class="inline-form">
              <div class="form-input-group">
                <input 
                  type="number" 
                  formControlName="targetBalance"
                  class="form-control"
                  [ngClass]="{'invalid': targetForm.get('targetBalance')?.invalid && targetForm.get('targetBalance')?.touched}"
                  step="100"
                >
                <span class="currency-label">{{ account.currency }}</span>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-sm btn-primary" [disabled]="targetForm.invalid">Enregistrer</button>
                <button type="button" class="btn btn-sm btn-secondary" (click)="showTargetForm = false">Annuler</button>
              </div>
              <div class="error-message" *ngIf="targetForm.get('targetBalance')?.invalid && targetForm.get('targetBalance')?.touched">
                L'objectif doit être d'au moins 100 {{ account.currency }}.
              </div>
            </form>
          </div>
        </div>
        <div class="info-row">
          <span class="label">Dépôts totaux:</span>
          <span class="value">{{ account.totalDeposits | currency:account.currency }}</span>
        </div>
        <div class="info-row">
          <span class="label">Retraits totaux:</span>
          <span class="value">{{ account.totalWithdrawals | currency:account.currency }}</span>
        </div>
        <div class="info-row">
          <span class="label">Profits totaux:</span>
          <span class="value positive">{{ account.totalProfits || 0 | currency:account.currency }}</span>
        </div>
        <div class="info-row">
          <span class="label">Pertes totales:</span>
          <span class="value negative">{{ account.totalLosses || 0 | currency:account.currency }}</span>
        </div>
        <div class="info-row">
          <span class="label">Date de création:</span>
          <span class="value">{{ account.createdAt | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">Performance</div>
      <div class="card-body">
        <div class="info-row">
          <span class="label">Progression vers l'objectif:</span>
          <span class="value">{{ performance$ | async | number:'1.1-1' }}%</span>
          <div class="progress">
            <div class="progress-bar" 
                 [style.width.%]="(performance$ | async) ?? 0 | number:'1.0-0'">
            </div>
          </div>
        </div>
        <div class="info-row">
          <span class="label">Profit/Perte:</span>
          <span class="value" [ngClass]="{
            'positive': (profitLoss$ | async) ?? 0 > 0,
            'negative': (profitLoss$ | async) ?? 0 < 0
          }">
            {{ profitLoss$ | async | currency:account.currency }}
          </span>
        </div>
        <div class="info-row">
          <span class="label">ROI:</span>
          <span class="value" [ngClass]="{
            'positive': (roi$ | async) ?? 0 > 0,
            'negative': (roi$ | async) ?? 0 < 0
          }">
            {{ roi$ | async | number:'1.1-1' }}%
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="withdrawal-section">
    <div class="card">
      <div class="card-header">
        <div class="header-with-action">
          <span>Stratégie de Retrait Intelligent</span>
          <a routerLink="/withdrawal-settings" class="settings-link">
            <i class="fas fa-cog"></i> Paramètres
          </a>
        </div>
      </div>
      <div class="card-body">
        <div *ngIf="(withdrawalRecommendation$ | async) as recommendation" class="smart-withdrawal-section">
          <!-- Informations financières principales -->
          <div class="withdrawal-info-grid">
            <div class="info-box">
              <div class="info-box-label">Dépôt total</div>
              <div class="info-box-value">{{ account.totalDeposits | currency:account.currency }}</div>
            </div>
            
            <div class="info-box">
              <div class="info-box-label">Gain total</div>
              <div class="info-box-value positive">{{ account.currentBalance - account.totalDeposits | currency:account.currency }}</div>
            </div>
            
            <div class="info-box highlight">
              <div class="info-box-label">Montant à retirer</div>
              <div class="info-box-value accent">{{ recommendation.recommendedAmount | currency:account.currency }}</div>
              <div class="info-box-subtitle">({{ recommendation.appliedRule.profitPercentageToWithdraw }}% des profits)</div>
            </div>
            
            <div class="info-box">
              <div class="info-box-label">Solde après retrait</div>
              <div class="info-box-value">{{ recommendation.remainingBalance | currency:account.currency }}</div>
            </div>
          </div>
          
          <!-- Information sur la plage de capital applicable -->
          <div class="applied-range-info">
            <h4>Plage de capital applicable</h4>
            <div class="range-details">
              <div class="range-amount">
                {{ recommendation.appliedRange.minAmount | currency:account.currency }} - {{ recommendation.appliedRange.maxAmount | currency:account.currency }}
              </div>
              <div class="range-rules">
                <div class="rule-title">Règles de retrait :</div>
                <div class="rule-list">
                  <div class="rule-item" *ngFor="let rule of recommendation.appliedRange.withdrawalRules" 
                       [ngClass]="{'active-rule': rule.targetPercentage === recommendation.appliedRule.targetPercentage}">
                    <span class="rule-target">{{ rule.targetPercentage }}% de l'objectif :</span>
                    <span class="rule-action">Retirer {{ rule.profitPercentageToWithdraw }}% des profits</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Bouton d'action -->
          <div class="withdrawal-action">
            <button type="button" class="btn btn-withdrawal" (click)="toggleTransactionForm('withdrawal', recommendation.recommendedAmount, 'Retrait intelligent recommandé', true)">
              <i class="fas fa-hand-holding-usd action-icon"></i>Effectuer ce retrait
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Aucune recommandation disponible -->
    <div class="card" *ngIf="!(withdrawalRecommendation$ | async)">
      <div class="card-header">
        <div class="header-with-action">
          <span>Stratégie de Retrait Intelligent</span>
          <a routerLink="/withdrawal-settings" class="settings-link">
            <i class="fas fa-cog"></i> Paramètres
          </a>
        </div>
      </div>
      <div class="card-body">
        <div class="no-recommendation">
          <p>Aucune recommandation de retrait disponible pour le moment. Cela peut être dû à :</p>
          <ul>
            <li>Pas encore de profits suffisants</li>
            <li>Objectif de compte non défini ou trop élevé</li>
            <li>Progression insuffisante vers l'objectif</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <div id="transactions-section" class="transactions-section">
    <div class="section-header">
      <h3 id="transactions-title">Historique des Transactions</h3>
      <button class="btn btn-primary add-transaction-btn" (click)="toggleTransactionForm('deposit', 0, '', true)" *ngIf="!showTransactionForm"><i class="fas fa-plus-circle mr-2"></i>Ajouter une transaction</button>
    </div>
    
    <div id="transaction-form" class="transaction-form-container" *ngIf="showTransactionForm">
      <form [formGroup]="transactionForm" (ngSubmit)="addTransaction()" class="transaction-form">
        <div class="form-group">
          <label for="type">Type de transaction:</label>
          <select id="type" formControlName="type" class="form-control" [ngClass]="{'invalid': transactionForm.get('type')?.invalid && transactionForm.get('type')?.touched}">
            <option value="deposit">Dépôt</option>
            <option value="withdrawal">Retrait</option>
            <option value="transfer">Transfert</option>
            <option value="profit">Gain de trading</option>
            <option value="loss">Perte de trading</option>
          </select>
        </div>
        
        <!-- Champ pour le solde final (uniquement pour profit et loss) -->
        <div class="form-group" *ngIf="transactionForm.get('type')?.value === 'profit' || transactionForm.get('type')?.value === 'loss'">
          <label for="finalBalance">Solde final souhaité ({{ account.currency }}):</label>
          <input 
            type="number" 
            id="finalBalance" 
            formControlName="finalBalance"
            class="form-control"
            (input)="calculateAmountFromFinalBalance()"
          >
          <small class="form-text text-muted">
            Saisissez le solde final de votre compte après le gain ou la perte. Le montant sera calculé automatiquement.
          </small>
        </div>
        
        <div class="form-group">
          <label for="amount">Montant ({{ account.currency }}):</label>
          <input 
            type="number" 
            id="amount" 
            formControlName="amount"
            class="form-control"
            [ngClass]="{'invalid': transactionForm.get('amount')?.invalid && transactionForm.get('amount')?.touched}"
            (input)="calculateFinalBalanceFromAmount()"
          >
          <div class="error-message" *ngIf="transactionForm.get('amount')?.invalid && transactionForm.get('amount')?.touched">
            Le montant doit être supérieur à 0.
          </div>
        </div>
        
        <div class="form-group">
          <label for="date">Date de la transaction:</label>
          <input 
            type="datetime-local" 
            id="date" 
            formControlName="date"
            class="form-control"
          >
        </div>
        
        <div class="form-group">
          <label for="description">Description (optionnel):</label>
          <textarea id="description" formControlName="description" class="form-control"></textarea>
        </div>
        
        <!-- Champ pour l'origine des fonds (uniquement pour dépôts et retraits) -->
        <div class="form-group" *ngIf="transactionForm.get('type')?.value === 'deposit' || transactionForm.get('type')?.value === 'withdrawal'">
          <label for="source">Origine des fonds:</label>
          <input id="source" formControlName="source" class="form-control" placeholder="Ex: Virement bancaire, PayPal, etc.">
        </div>
        
        <!-- Champ pour sélectionner le compte de destination (uniquement pour les transferts) -->
        <div class="form-group" *ngIf="transactionForm.get('type')?.value === 'transfer'">
          <label for="targetAccountId">Compte de destination:</label>
          <select id="targetAccountId" formControlName="targetAccountId" class="form-control" [ngClass]="{'invalid': transactionForm.get('targetAccountId')?.invalid && transactionForm.get('targetAccountId')?.touched}">
            <option value="">Sélectionnez un compte</option>
            <option *ngFor="let acc of (availableAccounts$ | async)" [value]="acc.id" [disabled]="acc.id === (account$ | async)?.id">
              {{ acc.name }} ({{ acc.currency }})
            </option>
          </select>
          <div class="error-message" *ngIf="transactionForm.get('targetAccountId')?.invalid && transactionForm.get('targetAccountId')?.touched">
            Veuillez sélectionner un compte de destination.
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="toggleTransactionForm()"><i class="fas fa-times mr-2"></i>Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="transactionForm.invalid">
            <i class="fas fa-save mr-2"></i>{{ isEditMode ? 'Mettre à jour' : 'Enregistrer' }}
          </button>
        </div>
      </form>
    </div>
    
    <div class="transactions-list">
      <div *ngIf="(transactions$ | async)?.length === 0" class="no-transactions">
        Aucune transaction pour ce compte.
      </div>
      
      <div class="transaction-item" *ngFor="let transaction of (transactions$ | async)">
        <div class="transaction-icon" [ngClass]="{
          'deposit-icon': transaction.type === 'deposit',
          'withdrawal-icon': transaction.type === 'withdrawal',
          'transfer-icon': transaction.type === 'transfer',
          'profit-icon': transaction.type === 'profit',
          'loss-icon': transaction.type === 'loss'
        }">
          <i class="{{ 
              transaction.type === 'deposit' ? 'fas fa-arrow-up' : 
              transaction.type === 'withdrawal' ? 'fas fa-arrow-down' : 
              transaction.type === 'transfer' ? 'fas fa-exchange-alt' :
              transaction.type === 'profit' ? 'fas fa-chart-line' :
              'fas fa-chart-line fa-flip-vertical'
            }}"></i>
        </div>
        
        <div class="transaction-details">
          <div class="transaction-header">
            <span class="transaction-type">
              {{ 
                transaction.type === 'deposit' ? 'Dépôt' : 
                transaction.type === 'withdrawal' ? 'Retrait' : 
                transaction.type === 'transfer' ? 'Transfert' :
                transaction.type === 'profit' ? 'Gain de trading' :
                'Perte de trading'
              }}
            </span>
            <span class="transaction-date">{{ transaction.date | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          
          <div class="transaction-amount" [ngClass]="{
            'positive': transaction.type === 'deposit' || transaction.type === 'profit',
            'negative': transaction.type === 'withdrawal' || transaction.type === 'loss',
            'transfer': transaction.type === 'transfer'
          }">
            {{ transaction.type === 'deposit' || transaction.type === 'profit' ? '+' : transaction.type === 'withdrawal' || transaction.type === 'loss' ? '-' : '' }} 
            {{ transaction.amount | currency:transaction.currency }}
            <span *ngIf="transaction.type === 'transfer' && transaction.targetAccountId" class="transfer-info">
              {{ transaction.accountId === account.id ? 'vers' : 'depuis' }} 
              {{ transaction.accountId === account.id ? getAccountName(transaction.targetAccountId) : getAccountName(transaction.accountId) }}
              <span *ngIf="transaction.exchangeRate" class="exchange-rate">
                (taux: {{ transaction.exchangeRate }})
              </span>
            </span>
          </div>
          
          <div class="transaction-description" *ngIf="transaction.description">
            {{ transaction.description }}
          </div>
          
          <!-- Affichage de l'origine des fonds pour les dépôts et retraits -->
          <div class="transaction-source" *ngIf="transaction.source && transaction.type !== 'transfer'">
            <strong>Origine:</strong> {{ transaction.source }}
          </div>
          
          <!-- Boutons d'action pour la transaction -->
          <div class="transaction-actions">
            <button class="btn btn-sm btn-primary" (click)="editTransaction(transaction)"><i class="fas fa-edit mr-1"></i>Modifier</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
